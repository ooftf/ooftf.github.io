---
layout: post
author: "ooftf"
tags: Android
---

# Process
## 什么是进程
进程系统进行资源分配和调度的基本单位，是程序在内存中的实例;进程之间内存相互独立

## 多进程应用的优点
* Android 对单个进程是有内存大小限制的，多进程可以申请更多的总内存，减少单个进程占用内存的大小
* 进程间崩溃不会相互影响
* APP保活（前台进程优先级比较高；进程优先级越高、单个进程占用内存越小被杀死的优先级越小）
## 常见的多进程案例
* 将 WebView 放入单独进程
* 图片选择器放入单独进程
* 将功能比较独立的功能放入单个进程，比如 网络日志查看、崩溃日志查看等功能
## 多进程会存在那些问题
* 进程间内存相互独立，无法相互访问
    * ActivityLifeCycleCallbacks 只能拿到各自进程Activity的生命周期
    * 单例等静态资源会存在多份
    * 多进程会初始化多个Application
    * sp多进程无法及时同步
* 多进程在同时读写文件的时候会出问题
    * sp
    * db
    * 文件读写

* WebView cookie 问题
    * 原生 CookieManager cookie 可以同步
    * X5  CookieManger cookie 不可以
* A 进程 startActivity 新 Activity 在哪个进程中
    ```xml
    <activity android:multiprocess="true"> 
    ```
    * 默认情况下，未指定进程就是主进程，如果指定了进程就会指定进程中 
    * multiprocess = true 的情况下从哪个进程启动就存在于哪个进程 
  
* SharedPreferences 跨进程问题
    不可以,如果提交方式未apply则可以同步一次，这是一个假象，最终结果是不可以
    解决方案 ContentProvider或者Aidl桥接或者MMKV

## Messenger
底层依然是AIDL，加上Handle的一种封装
## AIDL
AIDL + Service实现跨进程通讯
AIDL 文件同一个interface 不可以有两个同名方法，即使参数不同也不可以
* AIDL方法是在服务端的Binder线程池中执行
* 如果知道服务端方法是耗时的，那么就要避免在客户端的UI线程中访问这个远程方法

![AIDL流程图](http://assets.processon.com/chart_image/5c6f5920e4b0f0908a9d2f6d.png)

## 进程间通讯
### [IPC](https://www.jianshu.com/p/392922c1b036)
- Intent传递数据
- 共享文件文件
- Messenger  (轻量级AILD，使用方便)（基于Binder）
- ContentProvider（基于Binder）
- AILD（基于Binder）
- Socket

#### 比较
![6 种 IPC 方式优劣势比较](https://github.com/ooftf/ooftf.github.io/blob/master/images/ipc.jpg?raw=true)
