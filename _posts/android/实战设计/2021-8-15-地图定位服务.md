---
published: false
---

https://www.cnblogs.com/airker/p/14838382.html

## 要求

工作日 9 点开始不断的获取用户定位，然后上传到服务器，18点关闭定位。

页面可以获取定位信息生成轨迹地图

## 架构设计

分为六个模块

1. 定时任务模块
2. 定位服务模块
3. 数据储存模块
4. 上传服务模块
5. 显示轨迹模块
6. 跨进程通讯模块


### 定时任务模块

采用的 AlarmManager + Receiver 负责定位服务的定时开启和关闭

### 定位服务模块

采用百度地图连续定位，GPS 定位优先，高精度模式

百度定位可能会返回，基站定位 wifi 定位结果，对结果进行过滤只保留 GPS 定位结果

连续定位比较耗电，因为需要设置定位间隔策略，我们采用一种正向循环策略，如果两次定位之间的速度在增加那么我们会将定位间隔不断减少，如果两次定位之间的速度在不断的减少那么我们会将定位间隔不断的增加。当然这是有一个范围的大概范围在 5秒到 - 30 秒之间

需要添加通知开启前台服务

### 数据存储模块
1. sqlite 数据库
1. 使用 synchronized 保证同时只有一个线程访问表数据
2. 定位服务添加的数据。上传服务上传成功后，从数据库中删除对应的数据

## 上传服务模块

采用批量上传

从数据模块获取多个数据，调用 https 上传接口上传数据，如果上传成功通知上传模块，哪些数据上传成功

## 5. 显示数据模块

显示数据模块会从服务器拉取对应的轨迹数据，并且合并当前数据库中未上传成功的数据，通过百度地图 API 显示在地图上。

## 6. 跨进程通讯模块

采用 AIDL

其功能包括从主进程获取用户信息、注册监听登录和登出事件。

## 需要解决的问题

定位精准度问题

不断定位号点问题

进程保活问题

网络不稳定等原因造成的上传失败问题

## 耦合问题

模块之间通过工厂模式获取实现进行解耦








